{% extends "base_generic.html" %} {% block content %} {% load static %}

<img src="{{ movie.poster_path }}" style="max-width: 100%;" />
<h1>{{ movie.title }}</h1>
<p><strong>Duration:</strong> {{ movie.runtime }}</p>
<p><strong>Release Date:</strong> {{ movie.release_date }}</p>

<p><strong>Plot:</strong> {{ movie.overview }}</p>
<p><strong>Directors:</strong> {{ movie.directors|join:", " }}</p>
<p><strong>Writers:</strong> {{ movie.writers|join:", " }}</p>
<p><strong>Genre:</strong> {{ movie.genres|join:", " }}</p>
<!-- <p><strong>Actors:</strong> <br>
  {% for actor in movie.actors %}
    <img src="{{ actor.profile_path }}" style="max-width: 100px; max-height: 100px; margin-right: 10px;" />
    <p>{{ actor.name }} ({{ actor.character }})</p>
  {% endfor %}
</p> -->

{% if not user.is_authenticated %}
<p class="text-center">Log in to make a review</p>
{% endif %}

<form action="{% url 'rating' movie.id %}" method="POST" class="flex-column align-items-center w-50">
  {% csrf_token %} {{ form.errors }}
  <div hidden> {{ movie.film }}</div>
  <div>{{form.review_title}}</div>
  <div class="pt-3 mb-2">{{form.review}}</div>
  <div class="text-center d-flex flex-row align-items-center w-100">
    <div class="d-flex justify-content-between">
      {% for rate in RATING_CHOICES %}
      <input type="radio" name="score" id="score{{ forloop.counter }}" value="{{ rate.0 }}" required hidden />
      <label class="fa fa-star star fa-2x mx-2" for="score{{ forloop.counter }}" id="{{ forloop.counter }}"></label>
      {% endfor %}
      {% if form.errors %}
      <div class="rounded text-center alert-danger p-auto px-3">
        {{form.errors}}
      </div>
      {% endif %}
    </div>
    <div class="d-inline-flex flex-row justify-content-end col" >
      {% if user_rating %}
      <a href="{% url 'rating-delete' movie.id %}" class="btn btn-warning d-block" style="background: #aa4747;
    opacity: 80%;
    border: none;
    color: #dd8686;text-decoration: none;">
        <b>Delete</b></a>
      {% endif %}
      <button class="btn btn-primary d-block main-button" type="submit" value="submit" name="submit">
        <b>{% if form.score.value == 0 %}Submit{% else %}Update{% endif %}</b>
      </button>
    </div>
</form>

{% for review in reviews %}
  {% include 'web/review.html' with review=review %}
{% endfor%}

</div>

<script>
  const one = document.getElementById("1");
  const two = document.getElementById("2");
  const three = document.getElementById("3");
  const four = document.getElementById("4");
  const five = document.getElementById("5");

  const arr = [one, two, three, four, five];

  const selected_class = "selected"
  const checked_class = "checked"

  const get_button_type_str = (value) => value == "True" ? "upvote" : "downvote"

  const colorize_reputation = (rating_pk, value) => {
    const type = get_button_type_str(value)
    const button = document.getElementById(type + "-button-" + rating_pk)
    if (button) {
      button.classList.add(type)
    }
  }

  const toggle_reputation_color = (type, rating_pk, user_pk) => {
    const othertype = type == "upvote" ? "downvote" : "upvote"

    const button = document.getElementById(type + "-button-" + rating_pk).classList
    const otherbutton = document.getElementById(othertype + "-button-" + rating_pk).classList

    if (button.contains(type)) {
      button.remove(type)
    } else {
      button.add(type)
      otherbutton.remove(othertype)
    }
  }

  {% for rating in ratings %}
  document.getElementById("upvote-button-" + {{ rating.pk }}).addEventListener("click", (event) => toggle_reputation_color("upvote", {{ rating.pk }}, {{ rating.user.pk }}))
  document.getElementById("downvote-button-" + {{ rating.pk }}).addEventListener("click", (event) => toggle_reputation_color("downvote", {{ rating.pk }}, {{ rating.user.pk }}))
  {% endfor %}
  {% for rating in ratings %} {% for reputation in rating.reputation_set.all %}
  {% if reputation.user == user %}
  colorize_reputation({{ rating.pk }}, "{{reputation.value}}")
  {% endif %} {% endfor %} {% endfor %}

  const reputation_form_id = "reputation-form-"
  const reputation_form = document.querySelectorAll('[id^=' + reputation_form_id + ']')
  reputation_form.forEach((item) => {
    item.addEventListener("submit", preventRefresh) // Prevent page refresh on submit
    colorize_reputation(item)
  })

  const handle_mouseout = () => {
    for (let i = 0; i < arr.length; i++) {
      const current_class_list = arr[i].classList
      if (!current_class_list.contains(selected_class)) {
        current_class_list.remove(checked_class)
      }
    }
  }

  const handle_select = (target_id) => {
    const target = parseInt(target_id);
    for (let i = 0; i < arr.length; i++) {
      if (i < target) {
        arr[i].classList.add(selected_class)
        arr[i].classList.add(checked_class)
      } else {
        arr[i].classList.remove(selected_class)
        arr[i].classList.remove(checked_class)
      }
    }
  }

  const handle_hover = (target_id) => {
    const target = parseInt(target_id);
    for (let i = 0; i < arr.length; i++) {
      if (i < target) {
        if (!arr[i].classList.contains(selected_class)) {
          arr[i].classList.add(checked_class)
        }
      } else {
        if (!arr[i].classList.contains(selected_class)) {
          arr[i].classList.remove(checked_class)
        }
      }
    }
  }

  arr.forEach((item) =>
    item.addEventListener("mouseover", (event) => handle_hover(event.target.id))
  )

  arr.forEach((item) =>
    item.addEventListener("mouseout", (event) => handle_mouseout(event.target.id))
  )

  arr.forEach((item) =>
    item.addEventListener("click", (event) => handle_select(event.target.id))
  )

  function reputationSubmit(value, rating_pk, user_pk) {
    const getOtherStr = (value) => {
      return value == "upvote" ? "downvote" : "upvote"
    }

    var formButton = document.getElementById(value + "-button-" + rating_pk)
    var otherFormButton = document.getElementById(getOtherStr(value) + "-button-" + rating_pk)
    const isput = () => {
      const arr = ['upvote', 'downvote']
      return arr.some((el, ind, arr) => formButton.classList.contains(el) || otherFormButton.classList.contains(el))
    }

    var isupvote = value == "upvote"

    var httpmethod
    if (isput())
      httpmethod = 'PUT'
    else
      httpmethod = formButton.classList.contains(isupvote ? "upvote" : "downvote") ? "DELETE" : "POST"

    var formData = {
      'value': isupvote,
      'rating': rating_pk,
      'user': user_pk,
    }

    $.ajax({
      url: '/reputation/',
      type: httpmethod,
      headers: {
        'X-CSRFToken': Cookies.get('csrftoken')
      },
      data: formData,
      success: function (response) { }
    })
  }

  function preventRefresh(event) {
    event.preventDefault()
  }

  {% if form.score.value != 0 %}
  // Initalise previous user rating
  handle_select({{ form.score.value }})
  // Allows updating review without having to select a score again
  document.getElementById('score' + {{ form.score.value }}).checked = true
  {% endif %}
</script>
{% endblock %}