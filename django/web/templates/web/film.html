{% extends "base_generic.html" %} {% block content %} {% load static %}
<style>
  .checked {
    color: orange;
  }

  .star {
    max-width: 30px;
    cursor: pointer;
  }
</style>

<div class="row">
  <div class="col">
    <img
      class="rounded img-fluid mh-25"
      src="{{film.photo_url}}"
      alt="Film poster"
    />
  </div>
  <div class="col">
    <h1>{{ film.title }}</h1>
    <p><strong>Duration:</strong> {{ film.duration }}</p>
    <p><strong>Release Date:</strong> {{ film.release_date }}</p>

    <p><strong>Plot:</strong> {{ film.plot }}</p>
    <p><strong>Actors:</strong> {{ film.actors.all|join:", " }}</p>
    <p><strong>Directors:</strong> {{ film.directors.all|join:", " }}</p>
    <p><strong>Language:</strong> {{ film.languages.all|join:", " }}</p>
    <p><strong>Genre:</strong> {{ film.genres.all|join:", " }}</p>
  </div>
</div>
<div class="row">
  <form
    action="{% url 'rating' film.id %}"
    method="POST"
    class="mb-3 w-50 card-body d-flex flex-column align-items-center"
  >
    {% csrf_token %} {{ form.errors }}
    <div class="col text-center">
      {% if user.is_authenticated %}
      <p>Reviewing as: {{user}}</p>
      {% else %}
      <p>Log in to make a review</p>
      {% endif %}
      <div hidden>
        {{ form.film }}
        {{ form.score }}
      </div>
      {{ form.review_title }}
      {{ form.review }}
    </div>
    <br />
    <div class="col text-center">
        {% for rate in RATING_CHOICES %}
        <input
          hidden
          type="radio"
          name="score" id="score{{ forloop.counter }}"
          value="{{ rate.0 }}"
          required
        />
        <label class="mx-1 fa fa-star star fa-2x" for="score{{ forloop.counter }}" id="{{ forloop.counter }}"></label>
        {% endfor %}
        <div class="rounded text-center alert-danger p-auto px-3">
          {{form.errors}}
        </div>
    </div>
    <br/>
    <button
      class="btn btn-primary d-block main-button"
      type="submit"
      value="submit"
      name="submit"
    >
      <b>{% if form.score.value == 0 %}Submit{% else %}Update{% endif %}</b>

    </button>
  </form>
</div>

{% for rating in film.rating_set.all %}
<p>{{rating.user}} {{rating.score}} <b>{{rating.review_title}}</b> {{rating.review}}</p>

{% endfor%} 
<script>
  const one = document.getElementById("1");
  const two = document.getElementById("2");
  const three = document.getElementById("3");
  const four = document.getElementById("4");
  const five = document.getElementById("5");
  
  const arr = [one, two, three, four, five];
  
  const selected_class = "selected"
  const checked_class = "checked"
  
  const handle_mouseout = () => {
      for (let i = 0; i < arr.length; i++) {
          const current_class_list = arr[i].classList
          if (!current_class_list.contains(selected_class)) {
              current_class_list.remove(checked_class)
          }
      }
  }
  
  
  const handle_select = (target_id) => {
      const target = parseInt(target_id);
      for (let i = 0; i < arr.length; i++) {
          if (i < target) {
              arr[i].classList.add(selected_class);
              arr[i].classList.add(checked_class);
          } else {
              arr[i].classList.remove(selected_class);
              arr[i].classList.remove(checked_class);
          }
      }
  }
  
  const handle_hover = (target_id) => {
      const target = parseInt(target_id);
      for (let i = 0; i < arr.length; i++) {
          if (i < target) {
              if (!arr[i].classList.contains(selected_class)) {
                  arr[i].classList.add(checked_class);
              }
          } else {
              if (!arr[i].classList.contains(selected_class)) {
                  arr[i].classList.remove(checked_class);
              }
          }
      }
  };
  
  arr.forEach((item) =>
      item.addEventListener("mouseover", (event) => handle_hover(event.target.id))
  );
  
  arr.forEach((item) =>
      item.addEventListener("mouseout", () => handle_mouseout(event.target.id))
  );
  
  arr.forEach((item) =>
      item.addEventListener("click", (event) => handle_select(event.target.id))
  );
  
  // Initalise previous user rating
  if ({{ form.score.value }} != 0) {
    handle_select({{form.score.value}})
    // Allows updating review without having to select a score again
    document.getElementById('score' + {{ form.score.value }}).checked = true 
  }  

</script>
{% endblock %}
