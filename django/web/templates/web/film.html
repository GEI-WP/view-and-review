{% extends "base_generic.html" %} {% block content %} {% load static %}

<link rel="stylesheet" href="{% static 'css/film.css' %}" />

<div class="row">
  <div class="col">
    <h1>{{ film.title }}</h1>
    <p><strong>Duration:</strong> {{ film.duration }}</p>
    <p><strong>Release Date:</strong> {{ film.release_date }}</p>

    <p><strong>Plot:</strong> {{ film.plot }}</p>
    <p><strong>Actors:</strong> {{ film.actors.all|join:", " }}</p>
    <p><strong>Directors:</strong> {{ film.directors.all|join:", " }}</p>
    <p><strong>Language:</strong> {{ film.languages.all|join:", " }}</p>
    <p><strong>Genre:</strong> {{ film.genres.all|join:", " }}</p>
  </div>
</div>
<div class="row">
  <form
    action="{% url 'rating' film.id %}"
    method="POST"
    class="mb-3 w-50 card-body d-flex flex-column align-items-center"
  >
    {% csrf_token %} {{ form.errors }}
    <div class="col text-center">
      {% if user.is_authenticated %}
      <p>Reviewing as: {{user}}</p>
      {% else %}
      <p>Log in to make a review</p>
      {% endif %}
      <div hidden>{{ form.film }} {{ form.score }}</div>
      {{ form.review_title }} {{ form.review }}
    </div>
    <br />
    <div class="col text-center">
      {% for rate in RATING_CHOICES %}
      <input
        hidden
        type="radio"
        name="score"
        id="score{{ forloop.counter }}"
        value="{{ rate.0 }}"
        required
      />
      <label
        class="fa fa-star star fa-2x"
        for="score{{ forloop.counter }}"
        id="{{ forloop.counter }}"
      ></label>
      {% endfor %}
      <div class="rounded text-center alert-danger p-auto px-3">
        {{form.errors}}
      </div>
    </div>
    <br />
    <button
      class="btn btn-primary d-block main-button"
      type="submit"
      value="submit"
      name="submit"
    >
      <b>{% if form.score.value == 0 %}Submit{% else %}Update{% endif %}</b>
    </button>
  </form>
</div>

{% for rating in film.rating_set.all %}
<div class="d-flex mb-3 w-50">
  <form
    id="reputation-form-{{rating.pk}}"
    class="card-body flex-column align-items-right"
  >
    {% csrf_token %}

    <div>
      <button
        type="submit"
        value="upvote"
        name="button_upvote"
        onclick="reputationSubmit(this.value, {{rating.pk}}, {{user.pk}})"
        id="upvote-button-{{rating.pk}}"
      >
        ↑
      </button>
      <button
        type="submit"
        value="downvote"
        name="button_downvote"
        onclick="reputationSubmit(this.value, {{rating.pk}}, {{user.pk}})"
        id="downvote-button-{{rating.pk}}"
      >
        ↓
      </button>
    </div>
  </form>
  <p>
    {{rating.user}} {{rating.score}}
    <b>{{rating.review_title}}</b> {{rating.review}}
  </p>
</div>
{% endfor%}

<script>
  const one = document.getElementById("1");
  const two = document.getElementById("2");
  const three = document.getElementById("3");
  const four = document.getElementById("4");
  const five = document.getElementById("5");

  const arr = [one, two, three, four, five];

  const selected_class = "selected"
  const checked_class = "checked"

  const get_button_type_str = (value) => value == "True" ? "upvote" : "downvote"

  const colorize_reputation = (rating_pk, value) => {
    const type = get_button_type_str(value)
    const button = document.getElementById(type + "-button-" + rating_pk)
    if(button) {
      button.classList.add(type)
    }
  }

  const toggle_reputation_color = (type, rating_pk, user_pk) => {
    const othertype = type == "upvote" ? "downvote" : "upvote" 
    
    const button = document.getElementById(type + "-button-" + rating_pk).classList
    const otherbutton = document.getElementById(othertype + "-button-" + rating_pk).classList

    if (button.contains(type)) {
      button.remove(type)
    } else {
      button.add(type)
      otherbutton.remove(othertype)
    }
  }

  {% for rating in film.rating_set.all %}
  document.getElementById("upvote-button-" + {{rating.pk}}).addEventListener("click", (event) => toggle_reputation_color("upvote", {{rating.pk}}, {{rating.user.pk}}))
  document.getElementById("downvote-button-" + {{rating.pk}}).addEventListener("click", (event) => toggle_reputation_color("downvote", {{rating.pk}}, {{rating.user.pk}}))
  {% for reputation in rating.reputation_set.all %}{% if reputation.user == user %}
  colorize_reputation({{rating.pk}}, "{{reputation.value}}")
  {% endif %}{% endfor%}{% endfor %}

  const reputation_form_id = "reputation-form-"
  const reputation_form = document.querySelectorAll('[id^=' + reputation_form_id + ']')
  reputation_form.forEach((item) => {
    item.addEventListener("submit", preventRefresh) // Prevent page refresh on submit
    colorize_reputation(item)
  })

  const handle_mouseout = () => {
      for (let i = 0; i < arr.length; i++) {
          const current_class_list = arr[i].classList
          if (!current_class_list.contains(selected_class)) {
              current_class_list.remove(checked_class)
          }
      }
  }

  const handle_select = (target_id) => {
      const target = parseInt(target_id);
      for (let i = 0; i < arr.length; i++) {
          if (i < target) {
              arr[i].classList.add(selected_class)
              arr[i].classList.add(checked_class)
          } else {
              arr[i].classList.remove(selected_class)
              arr[i].classList.remove(checked_class)
          }
      }
  }

  const handle_hover = (target_id) => {
      const target = parseInt(target_id);
      for (let i = 0; i < arr.length; i++) {
          if (i < target) {
              if (!arr[i].classList.contains(selected_class)) {
                  arr[i].classList.add(checked_class)
              }
          } else {
              if (!arr[i].classList.contains(selected_class)) {
                  arr[i].classList.remove(checked_class)
              }
          }
      }
  }

  arr.forEach((item) =>
      item.addEventListener("mouseover", (event) => handle_hover(event.target.id))
  )

  arr.forEach((item) =>
      item.addEventListener("mouseout", (event) => handle_mouseout(event.target.id))
  )

  arr.forEach((item) =>
      item.addEventListener("click", (event) => handle_select(event.target.id))
  )

  function reputationSubmit(value, rating_pk, user_pk) {
    var formData = new FormData(document.getElementById(reputation_form_id + rating_pk))
    var isupvote = value=="upvote"
    
    var formButton = document.getElementById(value+"-button-"+rating_pk)
    var httpmethod = formButton.classList.contains(isupvote ? "upvote" : "downvote") ? "DELETE" : "POST" 

    var formData = {
      'value': isupvote,
      'rating': rating_pk,
      'user': user_pk,
    }

    $.ajax({
      url: '/reputation/',
      type: httpmethod,
      headers: {
          'X-CSRFToken': Cookies.get('csrftoken')
      },
      data: formData,
      success: function(response) { }
  })
  }

  function preventRefresh(event) {
    event.preventDefault()
  }

  // Initalise previous user rating
  if ({{ form.score.value }} != 0) {
    handle_select({{form.score.value}})
    // Allows updating review without having to select a score again
    document.getElementById('score' + {{ form.score.value }}).checked = true
  }
</script>
{% endblock %}
